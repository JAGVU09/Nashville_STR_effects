---
title: "Exploration"
author: "James Gilbert"
date: "12/21/2021"
output: html_document
---
```{r}
library(httr)
library(tidyverse)
library(jsonlite)
library(sf)
library(leaflet)
library(geojsonio)
library(viridis)
```
Property Violations API URL
https://data.nashville.gov/resource/479w-kw2x.json

STRs API URL
https://data.nashville.gov/resource/2z82-v8pm.json

Council Districts spatial data URL
https://data.nashville.gov/resource/iw7r-m8qr.geojson

CHANGE THE $limit BACK TO 90000, and 13000!!! If you put limit to 100000 for Violations it returns a list and will not unnest. Do not exceed 90000 for the limit on the Query

```{r}
url = 'https://data.nashville.gov/resource/479w-kw2x.json'
query = list(
  '$select'= 'request,date_received,property_apn,property_address,reported_problem,council_district,mapped_location',
  '$limit' = 90000
)
response<- GET(url, query=query)
Violations <- content(response, as = 'text') %>% 
  fromJSON()

#write_json(Violations, '../data/Violations.json')
url = 'https://data.nashville.gov/resource/2z82-v8pm.json'
query = list(
  '$select'= 'permit, permit_status, parcel, address, council_dist, mapped_location',
  '$limit' = 13000
)
response <- GET(url, query = query)
STRs <- content(response, as = 'text') %>% 
  fromJSON()
#write_json(STRs, '../data/STRs.json')

url = 'https://data.nashville.gov/resource/iw7r-m8qr.geojson'

council_districts<-geojson_read(url, what ='sp')

STRs<-STRs %>% unnest(mapped_location) %>% 
  mutate_at(.vars = c('latitude', 'longitude'), ~as.numeric(.))
Violations<-Violations %>% unnest(mapped_location) %>% 
  mutate_at(.vars = c('latitude', 'longitude'), ~as.numeric(.))
```



```{r}
url = 'https://data.nashville.gov/resource/479w-kw2x.json'

query = list(
  '$select'= 'request,date_received,property_apn,property_address,reported_problem,council_district,mapped_location',
  '$limit' = 90000
)

response<- GET(url, query=query)

Violations <- content(response, as = 'text') %>% 
  fromJSON()%>%
  unnest('mapped_location') %>% 
  mutate_at(.vars = c('latitude', 'longitude'), ~as.numeric(.))

#write_json(Violations, '../data/Violations.json')

url = 'https://data.nashville.gov/resource/2z82-v8pm.json'

query = list(
  '$select'= 'permit, permit_status, parcel, address, council_dist, mapped_location',
  '$limit' = 13000
)

response <- GET(url, query = query)

STRs <- content(response, as = 'text') %>% 
  fromJSON() %>% 
  unnest('mapped_location') %>% 
  mutate_at(.vars = c('latitude', 'longitude'), ~as.numeric(.))

#write_json(STRs, '../data/STRs.json')

url = 'https://data.nashville.gov/resource/iw7r-m8qr.geojson'

council_districts<-geojson_read(url, what ='sp')


grouped_STRs<-STRs %>%
  group_by(council_dist) %>% 
  tally() %>% 
  rename(STRs_per_dist = n) %>% 
  arrange(desc(STRs_per_dist)) %>% 
  drop_na()

grouped_viol<-Violations %>% 
  group_by(council_district) %>% 
  tally() %>% 
  rename(Violations_per_dist = n) %>% 
  arrange(desc(Violations_per_dist)) %>% 
  drop_na()

```


```{r}
leaflet(data = STRs, options = leafletOptions(minZoom = 0, maxZoom = 20)) %>% 
  addTiles() %>% addProviderTiles(providers$Stamen.TonerLite,
                       options = providerTileOptions(noWrap = TRUE)) %>% 
  addMarkers(~longitude, ~latitude, clusterOptions = markerClusterOptions()) %>% 
  addPolygons(data = council_districts)

```


```{r}

STRbins <- c(0,10,20,50,100,200,500,1000,2000,3000)
STRbinpal <- colorBin(heat.colors(9), domain = grouped_STRs$STRs_per_dist, bins = STRbins, reverse = TRUE)

STRlabels <- sprintf(
  "<strong>%s</strong><br/>%g STRs / mi<sup>2</sup>",
  grouped_STRs$council_dist, grouped_STRs$STRs_per_dist
) %>% lapply(htmltools::HTML)


STRmap<- leaflet(data = STRs, options = leafletOptions(minZoom = 0, maxZoom = 20)) %>% 
  addTiles() %>% addProviderTiles(providers$Stamen.TonerLite,
                                  options = providerTileOptions(noWrap = TRUE)) %>% 
  addPolygons(data = council_districts,
              fillColor = ~STRbinpal(grouped_STRs$STRs_per_dist),
              opacity = 0.2,
              dashArray = "3",
              fillOpacity = 0.9,
              highlightOptions = highlightOptions(
                weight = 5,
                color = '#666',
                dashArray = "",
                fillOpacity = 0.7,
                bringToFront = TRUE),
              label = STRlabels,
              labelOptions = labelOptions(
                style = list('font-weight' = 'normal', padding = '3px 8px'),
                textsize = '15px',
                direction = 'auto'
              )
              )
              
  

STRmap
```

```{r}

Violbins <- c(0,100,200,400,700,1100,1600,2200,2900,3700,4600, 5600,6700)
Violbinpal <- colorBin(heat.colors(12), domain = grouped_viol$Violations_per_dist, bins = Violbins)

Viollabels <- sprintf(
  "<strong>%s</strong><br/>%g Violations / mi<sup>2</sup>",
  grouped_viol$council_dist, grouped_viol$Violations_per_dist
) %>% lapply(htmltools::HTML)


Violmap<- leaflet(data = Violations, options = leafletOptions(minZoom = 0, maxZoom = 20)) %>% 
  addTiles() %>% addProviderTiles(providers$Stamen.TonerLite,
                                  options = providerTileOptions(noWrap = TRUE)) %>% 
  addPolygons(data = council_districts,
              fillColor = ~Violbinpal(grouped_viol$Violations_per_dist),
              opacity = 0.2,
              dashArray = "3",
              fillOpacity = 0.9,
              highlightOptions = highlightOptions(
                weight = 5,
                color = '#666',
                dashArray = "",
                fillOpacity = 0.7,
                bringToFront = TRUE),
              label = Viollabels,
              labelOptions = labelOptions(
                style = list('font-weight' = 'normal', padding = '3px 8px'),
                textsize = '15px',
                direction = 'auto'
              )
              )

Violmap
```


```{r}
cor(grouped_STRs$STRs_per_dist, grouped_viol$Violations_per_dist)
```

'1' = 'Bordeaux, Joelton, Whites Creek, Scottsboro'
'2' = 'North Nashville, Bordeaux, Metro Center'
'3' = 'Brick Church, Goodlettseville, Madison, Whites Creek'
'4' = 'Brentwood'
'5' = 'East Nashville, Cleveland Park, Maxwell Heights'
'6' = 'East Nashville, Lockland Springs, Rosebank'
'7' = 'East Nashville, West Inglewood, Madison, District 7'
'8' = 'East Nashville, East Inglewood, Madison, District 8'
'9' = 'Madison, Neely's Bend'
'10' = 'Goodlettsville, Madison'
'11' = 'Old Hickory, Hermitage'
'12' = 'Hermitage'
'13' = 'Donelson, Airport'
'14' = 'Donelson, Hermitage'
'15' = 'Donelson, Opryland'
'16' = 'South Nashville, Woodbine'
'17' = 'South Nashville, Fairgrounds, Berry Hill, 12 South'
'18' = 'South Nashville, Waverly-Belmont, Vanderbilt'
'19' = 'North Nashville, South Nashville, Downtown'
'20' = 'West Nashville, The Nations, Cockrill Bend'
'21' = 'North Nashville, West End, Midtown, TSU'
'22' = 'West Nashville, Bellevue'
'23' = 'West Nashville, Belle Meade'
'24' = 'West Nashville, Sylvan Park'
'25' = 'Oak Hill, Green Hills'
'26' = 'Crieve Hall, Paragon Mills'
'27' = 'Southeast Nashville, Tusculum'
'28' = 'Southeast Nashville, Antioch'
'29' = 'Antioch Norht-Priest Lake'
'30' = 'Haywood-Tusculum'
'31' = 'Antioch West, Cane Ridge'
'32' = 'Antioch Central'
'33' = 'Antioch South, Can Ridge'
'34' = 'Oak Hill, Forest Hills'
'35' = 'Bellevue'

**Some general info**
**The STRs will only have data from 5/23/2016 onward. 
The Violations data set is for 3 years prior to the current date from when the data set was accessed. It may be better to access this through the API so it is current when the app is used. *API CALL COMPLETE*

For STRs & Violations, the address of the permitted STRs also has lat/long in parentheses. I'll need to extract this and make separate columns for mapping purposes. *USING THE API REMEDIED THIS.*

Make a list of the columns from each data set that are absolutely necessary and only pull those using the API. *DONE*

**Council district will be a good column to group by for graphing. UPDATE: pulled in another dataset that has the geometry for the council districts which should make heat mapping easier. I might merge all datasets on the council districts columns.  

**It looks like the types of property violations has a lot of variation in the wording. It might be hard to group by certain types of violations because I may miss some. 
**Property.APN and Parcel are the same info for the Violations and STRs respectively. 
  Change these columns to be the same in each dataframe and merge the datasets. 
  
** find a list of the council districts 'names' and recode the column...<- not a high priority. *DONE*

** I need to work on a merge that combines the Violations with STRs on the STRs address to get a list of "problematic" STRs. 

DATA EXPLORATION

What is the makeup of districts that have code violations reported?
pull in a dataset that has median house price for each district?

Heat map with years changing the amount of Code violations over time.







Alter this code for heat map
```{r}
bins <- c(3000,2750,2500,2250,2000,1750,1500,1250,1000,750,500,250,100,50,0)
pal <- colorBin("YlOrRd", domain = STRs$STRs_per_dist, bins = bins)

labels <- sprintf(
  "<strong>%s</strong><br/>%g people / mi<sup>2</sup>",
  states$name, STRs$STRs_per_dist,
) %>% lapply(htmltools::HTML)

leaflet(council_districts) %>%
  setView(-96, 37.8, 4) %>%
  addProviderTiles("MapBox", options = providerTileOptions(
    id = "mapbox.light",
    accessToken = Sys.getenv('MAPBOX_ACCESS_TOKEN'))) %>%
  addPolygons(
    fillColor = ~pal(density),
    weight = 2,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    label = labels,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto")) %>%
  addLegend(pal = pal, values = ~density, opacity = 0.7, title = NULL,
    position = "bottomright")

```

